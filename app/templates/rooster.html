<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Login</title>
        <link rel="stylesheet" href="../static/style.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

        <!-- Dayjs -->
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekOfYear.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/updateLocale.js"></script>

        <!-- Font awesome - icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <!-- select2 - https://select2.org/getting-started/installation  -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    </head>
    <body>
        <header class="main-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="50px">
                <path fill="#d30f4c" fill-rule="evenodd" d="M33.26 0H6.74S0 0 0 6.74v26.53S0 40 6.74 40H40V6.74S40 0 33.26 0z"></path>
                <path fill="#fef7f1" fill-rule="evenodd" d="M35.82 16.45a6 6 0 01-3.13 3.82c-1.79 1-3.45.93-3.93-.08a11.5 11.5 0 002.52-4.5 5.46 5.46 0 00.12-2.36c-.61-3.21-4.67-3.82-9.09-1.39l-.61-3.17-4.7 2.59.75 4a3.43 3.43 0 011.41-.55c1.49-.16 1.91 1.48.94 3.66a9.34 9.34 0 01-1.34 2.15l.88 4.66v.08c.67 3.16 4.74 3.74 9.15 1.27s7.47-6.96 7.03-10.18zM17.3 22a3.76 3.76 0 01-1.63.71c-1.49.15-1.91-1.5-.94-3.68a9.33 9.33 0 011.56-2.38l-.84-4.39-9.2 5.14 2.66 14 9.2-5.13z"></path>
            </svg>
            <h2>Aanwezigheidstool</h2>
        </header>
        {% set time_list = ['8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00'] %}
        {% set day_list = ['Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag', 'Zaterdag', 'Zondag'] %}

        <div id="popup" class="popup" style="display: none">
            <div class="popup-container">
                <h1>Nieuwe bijeenkomst</h1>
                <form id="new-meeting">
                    <div class="form-row">
                        <label>Bijeenkomst naam</label>
                        <input class="form-input" type="text" name="name" id="name-input" required>
                    </div>
                    <div class="form-row">
                        <label>Beschrijving (optioneel)</label>
                        <textarea class="form-input" type="text" name="description" id="description-input"></textarea>
                    </div>
                    <div class="form-row">
                        <label>Klas / Klassen:</label>
                        <!-- Groups are added in here with ajax request  -->
                        <select class="group-select" name="groups[]" multiple="multiple" id="group-input">

                        </select>
                    </div>
                    <div class="form-row">
                        <label>Begin / eind tijd</label>
                        <div>
                            <select class="form-select date-change" name="start_time" id="start-input" required>
                                {% for time in time_list%}
                                    <option value="{{ time }}">{{ time }}</option>
                                {% endfor%}
                            </select>
                            <select class="form-select date-change" name="end_time" id="end-input" required>
                                {% for time in time_list%}
                                    {% if time != '8:00'%}
                                        <option value="{{ time }}">{{ time }}</option>
                                    {%endif%}
                                {% endfor%}
                            </select>
                            <!-- <input type="time" min="8:00" max="23:00" name="start_time" id="start-input">
                            <input type="time" min="8:00" max="23:00" value="9:00" name="end_time" id="end-input"> -->
                        </div>
                    </div>
                    <div class="form-row">
                        <label>Datum</label>
                        <div>
                            <input class="form-date date-change" type="date" name="date" id="date-input" required>
                        </div>
                    </div>
                    <!-- Displays chosen date and time -->
                    <div id="selectedDate"></div>
                    <!-- Displays errors in the form  -->
                    <div id="form-error" class="error"></div>
                    <input class="form-submit" type="submit" value="Opslaan" id="meeting-submit">
                </form>
            </div>
        </div>

        <div class="rooster-wrapper"> 
            <section class="rooster-sidebar">
                <div class="menu-toggler">
                    <i class="fa fa-bars" style="font-size:30px"></i>
                </div>
                <div class="sidebar-content">
                    <!-- <a class="rooster-btn">+ Bijeenkomst toevoegen</a> -->
                    <p>Filter op:</p>
                    <p class="sidebar-title">Klas</p>
                    <select class="group-select" name="group" id="group-filter">
                        
                    </select>
                </div>
            </section>
            <section class="rooster-container">
                <!-- <input type="week" id="week-calendar" /> -->
                <a id="new-meeting-btn" class="rooster-btn">+ Bijeenkomst toevoegen</a>
                <div class="date-selection-row">
                    <div id="previous-btn" class="change-week-btn"><i class="fa fa-chevron-left" style="font-size:15px"></i></div><input class="rooster-calendar" type="date" id="week-calendar" onfocus="this.showPicker()" value=""/><div id="next-btn" class="change-week-btn reverse"><i class="fa fa-chevron-right" style="font-size:15px"></i></div>
                </div>
                <div class="rooster-day-row">
                    <div>
                        <p class="rooster-time-title">Week <span id="week-number"></span></p>
                        <section class="rooster-table">
                            {% for time in time_list%}
                            <div class="rooster-row">
                                <div class="rooster-time-text">{{time}}</div>
                            </div>
                            
                            {% endfor %}
                            
        
                        </section>
                    </div>
                    {% for day in day_list%}

                        <div class="rooster-day">
                            <!-- if statement in class list is to check for the current day, now for testing it checks for 1 --> 
                            <!-- loop.index has to change later to the day of the month -->
                            <p class="rooster-day-title">{{day}} <span id="day-{{ loop.index }}" class="rooster-day-number">{{ loop.index }}</span></p>
                            <section class="rooster-table">
                                {% for time in time_list%}
                                <div class="rooster-row">
                            
                                </div>
                                {% endfor %}
                                <div class="rooster-content" id="rooster-content-{{loop.index}}">
                                    <!-- <div class="rooster-content-item">
                                        <div>
                                            <p class="rooster-content-item-title">Les 1</p>
                                            <p class="rooster-content-item-text">8:00 - 9:00</p>
                                        </div>
                                        <p class="rooster-content-item-text">Docent</p>
                                    </div> -->
                                </div>
                            </section>
                        </div>
                    {% endfor %}

                </div>
            </section>
        </div>
    </body>
</html>
<script type="application/javascript">
    // dayjs -> https://day.js.org/docs/en/installation/installation
    // Maandag = 1
    // Dinsdag = 2
    // Woensdag = 3
    // Donderdag = 4
    // Vrijdag = 5
    // Zaterdag = 6
    // Zondag = 7

    const weekOfYear = window.dayjs_plugin_weekOfYear
    const weekday = window.dayjs_plugin_weekday
    const updateLocale = window.dayjs_plugin_updateLocale
    dayjs.extend(weekOfYear)
    dayjs.extend(weekday)
    dayjs.extend(updateLocale)

    // update months and days to dutch
    dayjs.updateLocale('en', {
        months: [
            "januari", "februari", "maart", "april", "mei", "juni", "juli",
            "augustus", "september", "oktober", "november", "december"
        ],
        weekdays: [
            "zondag", "maandag", "dinsdag", "woensdag", "donderdag", "vrijdag", "zaterdag"
        ]
      })

    var currentWeekMonday = dayjs().day(1).format('YYYY-MM-DD')
    var currentWeekSunday = dayjs().day(7).format('YYYY-MM-DD')
    var today = dayjs().format('YYYY-MM-DD');
    
    

// <======= Meeting popup ========>
    // set new meeting popup date to today on load
    $('#date-input').val(today)

    function toggleNewMeetingPopup(){
        $('#popup').toggle();
    }

    $('#new-meeting-btn').click(function(){
        toggleNewMeetingPopup()
    })

    $('#popup').click(function(e){
        // check if the click is on the background or the popup 
        if (e.target == this){
            toggleNewMeetingPopup()
        }
    })

    $('.date-change').on('change', function (e) {
        let start = $('#start-input').val()
        let end = $('#end-input').val()
        let date = $('#date-input').val()
        date = dayjs(date).format('dddd D MMMM YYYY');
        $('#selectedDate').text(`${date} van ${start} tot ${end}`);
        console.log("group(s):", $('#group-input').val())

    });

    // AJAX request to save new meetings
    $("#meeting-submit").click(function (e)
    {
        e.preventDefault();

        // check if the input is valid using a 'valid' property
        var groups = $('#group-input').val()

        var meeting = {
            name : $('#name-input').val(),
            start_time : $('#start-input').val(),
            end_time : $('#end-input').val(),
            date : $('#date-input').val(),
            description : $('#description-input').val(),
        }

        $.ajax({
            method: "POST",
            url: "/api/meeting/",
            data : JSON.stringify(meeting),
            contentType: "application/json",
            dataType: 'json',
            beforeSend: function() {     
                // check if all input fields are filled           
                $empty = $('#new-meeting').find("input").filter(function() {
                    return this.value === "";
                });
                if($empty.length) {
                    $('#form-error').text("Vul alle vereiste velden in")
                    return false;
                }else{
                    return true;
                };
            },
            success:function(result)
            {
                // close popup
                toggleNewMeetingPopup()
                console.log(result);
                console.log("meeting id: ",result.meeting.id)
                // UPDATE: add all groups connected to this meeting to db
                for(group of groups){
                    addGroupToMeeting(group, result.meeting.id)
                }
                getMeetings(currentWeekMonday, currentWeekSunday, 'group 1')
            },
            error : function(request,error){
                alert("request failed", error);
            }
        });
    });

    // add group to meeting
    function addGroupToMeeting(groupId, meetingId){
        var groupMeeting = {
            group_id : groupId,
            meeting_id : meetingId
        }

        $.ajax({
            method: "POST",
            url: "/api/groupmeeting",
            data : JSON.stringify(groupMeeting),
            contentType: "application/json",
            dataType: 'json',
            success:function(result)
            {
                console.log("group added: ", result)
            },
            error : function(request,error){
                alert("request failed", error);
            }
        });
    }
// <======= ============ ========>

    // AJAX request to get meetings
    function getMeetings(startDate, endDate, group){
        console.log(startDate, endDate, group)
        $.ajax({ 
            type: "GET",
            url: "/api/meeting/between/"+startDate+"/"+endDate,
            contentType: "application/json",
            dataType: "json",  
            success: function(response_data){
                console.log(response_data);
                for(item of response_data.result){
                    // console.log(item.id, item)
                    createLessonBlock(day=dayjs(item.date).day(), name=item.name, start_time=formatTimeToNumber(item.start_time), end_time=formatTimeToNumber(item.end_time));
                }
            },
            error : function(request,error){
                console.log(request)
            }
        })
    }
    groupsArray = []
    // AJAX request to get groups
    function getGroups(){
        $.ajax({ 
            type: "GET",
            url: "/api/group",
            contentType: "application/json",
            dataType: "json",  
            success: function(response_data){
                console.log(response_data);
                for(item of response_data.result){
                    console.log(item.id, item)
                    groupsArray.push(item)
                }
            },
            error : function(request,error){
                console.log(request)
            }
        }).then(function(){
            console.log("groups: ", groupsArray)
            for(group of groupsArray){
                // add groups to places where a list of all groups is needed 
                let html_block = `<option value="${group.id}">${group.name}</option>`

                let formgroup = $("#group-input").append(html_block);
                let filtergroup = $("#group-filter").append(html_block);
            }
            $('#group-input').select2();
            $('#group-filter').select2();
        })
    }
    getGroups()

    

    // remove meetings from calendar
    function removeMeetings(){
        for(let i = 1; i<=7 ; i++){
            dayContainer = document.getElementById("rooster-content-"+i);
            dayContainer.innerHTML = ''
        }
    }


    // format time from HH:MM to H
    function formatTimeToNumber(time){
        // Use mockup date to be able format time to 9 or 10 instead of "9:00" or "10:00"
        hour = dayjs('2000-01-01T'+time).format('H')
        return hour
    }

    // set start week on calendar when first loaded
    function setCalendarDate(date) {
        document.getElementById('week-calendar').value = date;
    }
    setCalendarDate(today);

    // update weeknumber in html
    function updateWeekNumber(number){
        $('#week-number').text(number)
    }

    // sets active day of week on calendar
    function setActiveCalendarDay(date){
        $('.rooster-day-number').removeClass('active');

        let selectedDay = dayjs(date).day()
        if(selectedDay == 0){
            // if day is 0 it is sunday so set it to 7
            selectedDay = 7
        }

        $('#day-'+selectedDay).addClass('active')
    }

    // sets day numbers on calendar & updates the start and end day variables of the selected week
    function setWeekDayNumbers(date){
        // Update variables of start and end day of week
        currentWeekMonday = dayjs(date).day(1).format('YYYY-MM-DD')
        currentWeekSunday = dayjs(date).day(7).format('YYYY-MM-DD')
        console.log(currentWeekMonday, currentWeekSunday)

        // set correct day number in html calendar
        // if day == 0 it is sunday, so go back to monday so to day 1
        if(dayjs(date).day() == 0){
            for(let i = 1; i<=7 ; i++){
                let day_number = dayjs(date).day(-6).weekday(i).$D
                $('#day-'+i).text(day_number)
            }
        }else{
            for(let i = 1; i<=7 ; i++){
                let day_number = dayjs(date).weekday(i).$D
                $('#day-'+i).text(day_number)
            }
        }
    }
    
    // if calendar changes update the week in html
    $(document).ready(function(){
        $("#next-btn").click(function(){
            let value = $("#week-calendar").val();
            value = dayjs(value).add(7, 'day').format('YYYY-MM-DD');
            setCalendarDate(value)

            refreshCalendar(value)
        })

        $("#previous-btn").click(function(){
            let value = $("#week-calendar").val();
            value = dayjs(value).subtract(7, 'day').format('YYYY-MM-DD');
            setCalendarDate(value)

            refreshCalendar(value)
        })

        $('#week-calendar').on('change', function (e) {
            let value = $("#week-calendar").val();

            refreshCalendar(value)
        });
        var state = 0
        $('.menu-toggler').click(function(){
            state = !state
            if(state){
                $('.sidebar-content').css({ width: 'auto', padding: '20px'});
                $('.sidebar-content').show();
            }else{
                $('.sidebar-content').css({ width: '0', padding: '0px'});
                $('.sidebar-content').hide();

            }
        })
    });

    function refreshCalendar(value){
        setActiveCalendarDay(value);
        setWeekDayNumbers(value);
        updateWeekNumber(dayjs(value).week())
        // remove meetings
        removeMeetings()
        // fill the new meetings
        getMeetings(currentWeekMonday, currentWeekSunday, 'group 1')
    }
    // fill calendar with data on load
    refreshCalendar(today)
    
    // function to create a lesson block
    function createLessonBlock(day, name, start_time, end_time){
        console.log(day, name, start_time, end_time)
        // if day == 0 set it to 7 so that it is sunday
        if(day == 0){
            day = 7
        }
        // each hour is 100px
        let block_height = 100;
        // each lesson block is 90px in height
        let lesson_height = 90;
        // extra spacing for each block
        let block_spacing = 5
        // html code for a lesson
        let html_block = $(`                                 
        <div class="rooster-content-item">
            <div>
                <p class="rooster-content-item-title">${name}</p>
                <p class="rooster-content-item-text">${start_time}:00 - ${end_time}:00</p>
            </div>
            <p class="rooster-content-item-text">Docent</p>
        </div>`);
        // add lesson to html   
        let parent = document.getElementById("rooster-content-"+day);
        let element = $(parent).append(html_block);
        
        // this is the first time that is display on the rooster
        let rooster_first_time = 8
        // calculate top position on rooster
        let jump_blocks = start_time-rooster_first_time;
        let top_pos = jump_blocks*block_height;
        top_pos = top_pos+block_spacing;
        html_block.css({ top: top_pos+'px' });
        
        // calculate height of lesson block
        let lesson_blocks = end_time-start_time
        // calculate extra height, this is the space that is normally between lesson blocks
        let extra_height = (block_spacing*2)*(lesson_blocks-1)
        let height = lesson_blocks * lesson_height + extra_height;
        html_block.css({ height: height+'px' });
        
    }
    
</script>